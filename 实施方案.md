# S9 课堂交互系统 - 实施方案

> **项目**: Jarvis Copilot 在线教学系统  
> **版本**: v1.0  
> **日期**: 2025-12-15

---

## 一、当前状态

### ✅ 已完成
| 模块 | 状态 | 说明 |
|-----|------|------|
| 前端 UI | ✅ | 六阶段完整界面 (Warmup → Battle → Coaching → Vocab → Surgery → Review) |
| 状态同步 | ✅ | WebSocket 实时同步 (教练端 ↔ 学生端) |
| 视频通话 | ✅ | WebRTC 跨设备视频流 (HTTPS/WSS) |
| 数据模型 | ✅ | SQLAlchemy 模型 (Article, Version, Question, VocabCard, SentenceSurgery) |

---

## 二、项目 1 数据库兼容性分析

> ✅ **结论：项目 1 数据库已完全适配项目 2 需求！**

### 数据库表对照

| 项目 2 需求 | 项目 1 表 | 状态 | 说明 |
|-----------|----------|------|------|
| 文章内容 | `articles` | ✅ 匹配 | title, content, word_count |
| 分层版本 | `versions` | ✅ 匹配 | L0-L3 四个版本 |
| 阅读理解题 | `questions` | ✅ 匹配 | stem, options, correct_answer |
| AI Tutor 话术 | `questions.ai_tutor_script` | ❌ 不使用 | **实时 AI 生成** |
| 错误归因 | `questions.error_tags` | ✅ 已有 | 作为 AI 输入上下文 |
| 难句数据 | `sentence_surgeries` | ✅ 匹配 | original_sentence, translation |
| 视觉切分 | `sentence_surgeries.chunks_visual` | ✅ 已有 | core/modifier 切分数据 |
| 教练话术 | `sentence_surgeries.coach_script` | ✅ 已有 | 分层讲解脚本 |
| 词卡数据 | `vocab_cards` | ⚠️ 需调整 | 见下方说明 |

### ⚠️ 业务规则说明

**1. 词卡数据源调整**

项目 1 的 `vocab_cards` 表是预制词卡（按 version 关联），但项目 2 的业务规则是：

> **生词来源 = 学生在 Battle 阶段实时查询的单词**

因此需要：
- ❌ 不使用 `vocab_cards` 表的预制数据
- ✅ 使用 **字典 API** 实时查询学生查过的词
- ✅ 词卡信息由 AI 动态生成（音节、助记法等）

**2. AI Tutor 话术实时生成**

项目 1 的 `ai_tutor_script` 是预制的，但项目 2 **不使用预制话术**：

> **Jarvis Copilot = 实时调用 AI**，根据学生实际表现动态生成苏格拉底式引导话术

### 可直接复用的数据

```
项目1数据库
├── articles          → 直接复用
├── versions          → 直接复用 (content, questions, sentence_surgeries)
├── questions         → 直接复用 (error_tags 作为 AI 上下文)
├── sentence_surgeries → 直接复用 (含 chunks_visual, coach_script)
└── vocab_cards       → 仅作参考词库（非主要数据源）
```

---

## 三、依赖服务

### 必需服务
| 服务 | 用途 | 推荐方案 | 优先级 |
|-----|------|---------|-------|
| **PostgreSQL** | 数据存储 | Zeabur / Supabase | P0 |
| **字典 API** | 实时查词 | 有道词典 / 自建词库 | P0 |
| **TTS** | 单词发音 | Google TTS / Azure | P1 |
| **AI 模型** | Jarvis 话术 | Gemini API | P1 |

### 可选服务
| 服务 | 用途 | 说明 |
|-----|------|------|
| STT | 语音回答 | Phase 3 语音交互 |
| OSS | 文件存储 | 音频资源托管 |

---

## 四、分阶段实施计划

### 🎯 Phase 1: 数据层接入 (预计 3 天)

**目标**: 替换所有 Mock 数据，连接真实后端

#### 后端任务
```
Backend/
├── 1.1 配置生产数据库连接
├── 1.2 导入种子数据 (文章、版本、题目)
├── 1.3 完善 /api/articles/{id}/versions/{level} 返回
└── 1.4 新增 /api/vocab/lookup 字典查询接口
```

#### 前端任务
```
Frontend/
├── 1.5 创建 API 服务层 (apiService.ts)
├── 1.6 替换 MOCK_ARTICLE → fetchVersion()
├── 1.7 实现实时查词 → lookupWord()
└── 1.8 查词记录存入 store.lookups
```

#### 验收标准
- [ ] 文章从数据库加载
- [ ] 题目从数据库加载
- [ ] 查词调用真实 API

---

### 🎯 Phase 2: 核心交互完善 (预计 5 天)

**目标**: 完成六阶段核心业务逻辑

#### 2.0 热身阶段 (Warmup)
| 功能 | 说明 |
|-----|
| 用户画像 | 获取 UserProfile (level, tags) |
| 破冰话术 | 根据 tags 生成个性化开场白 |
| 课堂目标 | 展示今日阅读挑战目标 |

#### 2.1 实战阶段 (Battle)
| 功能 | 说明 |
|-----|------|
| 分层查词限制 | 基础模式: 3次 / 进阶模式: 0次 |
| 查词记录上报 | looked_up_words → 用于 Vocab 阶段 |
| 不确定标记 | 选项旁 [不确定] 按钮 |
| 倒计时 | 进阶模式显示计时器 |

#### 2.2 带练阶段 (Coaching)
| 功能 | 说明 |
|-----|------|
| 禁止查词 | 此阶段学生无法查词 |
| **实时 AI 话术** | 调用 Gemini 生成苏格拉底式引导 |
| 任务推送 | 教练发送划线/选择任务 |

#### 2.3 生词阶段 (Vocab)
| 功能 | 说明 |
|-----|------|
| **数据来源** | 从 Battle 阶段 looked_up_words 获取 |
| 词卡生成 | 调用字典 API 获取完整信息 |
| TTS 发音 | 播放单词标准发音 |
| 出门测试 | 全部勾选才能进入下一阶段 |

#### 2.4 难句阶段 (Surgery)
| 功能 | 说明 |
|-----|------|
| 数据加载 | 从 SentenceSurgery 获取 chunks_visual |
| 视觉切分 | 修饰语淡出，主干高亮 |
| 教练脚本 | 从 coach_script 获取话术 |

---

### 🎯 Phase 3: 高级功能 (预计 3 天)

**目标**: AI 辅助和数据统计

| 功能 | 说明 |
|-----|------|
| Jarvis Copilot | **AI 实时生成教练话术** |
| Session 日志 | 记录学习数据到 SessionLog |
| 战报生成 | Phase 6 数据可视化 |
| AI 助记 | 生词阶段动态生成助记法 |

#### Phase 2-3 验收标准
- [ ] Battle: 查词限制生效，looked_up_words 正确记录
- [ ] Coaching: AI 实时生成话术，禁止查词生效
- [ ] Vocab: 词卡来源为学生查词记录，字典 API 调用成功
- [ ] Surgery: chunks_visual 正确加载，视觉动画正常
- [ ] Review: Session 数据成功保存

---

## 五、API 设计

### 5.1 现有 API
```
GET  /api/articles                          # 文章列表
GET  /api/articles/{id}                     # 文章详情
GET  /api/articles/{id}/versions/{level}    # 版本 + 题目 + 难句
```

### 5.2 需新增 API
```
# 字典查询
POST /api/vocab/lookup
Body: { "word": "obsessed" }
Response: { word, phonetic, definition, syllables, example }

# 会话记录
POST /api/sessions
Body: { session_id, user_id, version_id, looked_up_words, quiz_results }

# TTS 发音
GET  /api/tts/{word}
Response: audio/mp3

# AI 话术生成 (Jarvis Copilot)
POST /api/ai/coaching
Body: { 
  question_id, 
  student_answer, 
  correct_answer, 
  error_tags,
  student_level 
}
Response: { script: "苏格拉底式引导话术..." }

# AI 助记生成
POST /api/ai/mnemonic
Body: { "word": "obsessed", "level": "L0" }
Response: { mnemonic: "💡 巧记：..." }
```

---

## 六、数据转换层设计

前后端字段名映射，建议实现 `dataTransform.ts` 服务：

| 前端字段 | 后端字段 | 转换 |
|---------|---------|-------|
| `question` | `stem` | 重命名 |
| `options[].id` | `options` | 格式拆分 "A. xxx" → {id, text} |
| `correctOption` | `correct_answer` | 重命名 |
| `paragraphs` | `content` | `content.split('\n\n')` |
| `mnemonic` | `ai_memory_hint` | 重命名 |
| `audioSrc` | `audio_url` | 重命名 |
| `contextSentence` | `context_sentence` | camelCase 转换 |

---

## 七、数据流

```
┌─────────────────────────────────────────────────────────────┐
│                     S9 课堂数据流                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  Phase 1: Warmup                                            │
│  └── 获取 UserProfile (level, tags)                         │
│                    ↓                                        │
│  Phase 2: Battle                                            │
│  ├── 加载 Version (content, questions)                      │
│  └── 记录 looked_up_words ─────────────────┐               │
│                    ↓                        │               │
│  Phase 3: Coaching                          │               │
│  ├── 实时调用 AI 生成话术                   │               │
│  └── 禁止查词                               │               │
│                    ↓                        │               │
│  Phase 4: Vocab  ←──────────────────────────┘               │
│  ├── 词卡来源 = looked_up_words                              │
│  └── 调用字典 API 获取详情                                   │
│                    ↓                                        │
│  Phase 5: Surgery                                           │
│  └── 加载 sentence_surgeries                                │
│                    ↓                                        │
│  Phase 6: Review                                            │
│  └── 保存 SessionLog                                        │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 八、AI Coaching Prompt 设计

### 7.1 Prompt 文件位置

```
backend/prompts/coaching_tutor.md
```

### 7.2 问题修复记录

| 原问题 | 解决方案 |
|-------|---------|
| 缺少全部选项参数 | 新增 `options` 数组，包含 A/B/C/D 完整选项对象 |
| Workflow 和 Constraints 逻辑冲突 | 统一机会计数逻辑：引导讨论不计次，正式选择最多2次 |

### 7.3 输入参数结构

```json
{
  "article": "完整文章内容",
  "question": {
    "stem": "题干",
    "options": [
      { "id": "A", "text": "选项A" },
      { "id": "B", "text": "选项B" },
      { "id": "C", "text": "选项C" },
      { "id": "D", "text": "选项D" }
    ],
    "correct_answer": "A",
    "type": "细节理解题",
    "error_tags": ["偷换概念"]
  },
  "student": {
    "selected_answer": "B",
    "level": "L0"
  },
  "solving_steps": ["步骤1...", "步骤2..."]
}
```

### 7.4 工作流程

```
Phase 1: 诊断 → 展示题目，询问学生选择和思路
Phase 2: 引导循环 → 按解题步骤逐步提问（最多2次选择机会）
Phase 3: 复盘 → 揭示答案，结构化总结
```

### 7.5 核心约束

1. **No Spoilers** - 禁止在问题中暗示答案
2. **Step-by-Step** - 每次只问一个问题
3. **2次机会** - 学生最多2次正式选择，之后必须揭示答案

---

## 九、环境配置

### Backend (.env)
```bash
DATABASE_URL=postgresql+asyncpg://user:pass@host:5432/s9_classroom
GEMINI_API_KEY=your_gemini_api_key
DICT_API_URL=https://dict-api.example.com
DICT_API_KEY=your_dict_api_key
```

### Frontend (.env)
```bash
VITE_API_URL=https://api.your-domain.com
VITE_WS_URL=wss://api.your-domain.com/ws
```

---

## 十、时间估算

| 阶段 | 工作量 | 时间 |
|-----|-------|------|
| Phase 1: 数据层接入 | 后端 API + 前端服务层 | 3 天 |
| Phase 2: 核心交互 | 六阶段业务逻辑 | 5 天 |
| Phase 3: 高级功能 | AI + 数据统计 | 3 天 |
| 测试与优化 | 联调 + Bug 修复 | 2 天 |
| **合计** | | **13 天** |

---

## 十一、风险与应对

| 风险 | 影响 | 应对措施 |
|-----|------|---------|
| 字典 API 不稳定 | Vocab 阶段异常 | 本地缓存 + 备用词库 |
| TTS 延迟高 | 用户体验差 | 预加载 + 音频缓存 |
| AI 响应慢 | Copilot 卡顿 | 流式响应 + 超时兜底 |
| 数据库连接问题 | 全站不可用 | 连接池 + 重试机制 |
