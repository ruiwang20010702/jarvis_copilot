# Jarvis Agent æ¶æ„è®¾è®¡æ–‡æ¡£

> **ç‰ˆæœ¬**: v1.1  
> **æ›´æ–°æ—¥æœŸ**: 2025-12-16  
> **çŠ¶æ€**: âœ… CoachingAgent å·²å®ç°  
> **é€‚ç”¨é¡¹ç›®**: jarvis_project_2 (å­¦ç”Ÿç«¯å­¦ä¹ åº”ç”¨)

---

## 1. æ¦‚è¿°

### 1.1 ä»€ä¹ˆæ˜¯ Jarvis Agentï¼Ÿ

Jarvis æ˜¯ä¸€ä¸ª **AI æ•™å­¦åŠ©æ‰‹**ï¼Œå®ƒèƒ½å¤Ÿï¼š
- ğŸ¯ **è§‚å¯Ÿ**ï¼šæ¥æ”¶å­¦ç”Ÿçš„æ“ä½œå’Œå›ç­”
- ğŸ§  **æ€è€ƒ**ï¼šåˆ†æå­¦ç”Ÿè¡¨ç°ï¼Œå†³å®šä¸‹ä¸€æ­¥æ•™å­¦ç­–ç•¥
- ğŸ› ï¸ **è¡ŒåŠ¨**ï¼šå‘å¸ƒä»»åŠ¡ã€å‘é€æ¶ˆæ¯ã€å±•ç¤ºæ•™å­¦å¡ç‰‡

**Agent ä¸ä¼ ç»Ÿ AI çš„åŒºåˆ«**ï¼š

| ä¼ ç»Ÿ AI | Jarvis Agent |
|---------|--------------|
| æ”¶åˆ°é—®é¢˜ â†’ è¿”å›ç­”æ¡ˆ | æ”¶åˆ°è¾“å…¥ â†’ æ€è€ƒ â†’ è°ƒç”¨å·¥å…· â†’ ç­‰å¾…åé¦ˆ â†’ å¾ªç¯ |
| æ— çŠ¶æ€ï¼Œæ¯æ¬¡ç‹¬ç«‹ | æœ‰çŠ¶æ€ï¼Œè®°ä½å¯¹è¯å†å²å’Œå­¦ä¹ è¿›åº¦ |
| è¢«åŠ¨å“åº” | ä¸»åŠ¨å†³ç­–ï¼Œæ§åˆ¶æ•™å­¦æµç¨‹ |

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦ Agent æ¶æ„ï¼Ÿ

ä»¥ã€Œä»£ç»ƒçº é”™ã€æ¨¡å—ä¸ºä¾‹ï¼Œæ•™å­¦æµç¨‹éœ€è¦ï¼š

1. **å¤šè½®äº¤äº’**ï¼šä¸€é“é”™é¢˜å¯èƒ½éœ€è¦ 6 ä¸ªæ­¥éª¤æ‰èƒ½è®²é€
2. **æ¡ä»¶è·³è½¬**ï¼šå­¦ç”Ÿç­”å¯¹å¯æå‰ç»“æŸï¼Œç­”é”™ 2 æ¬¡å¿…é¡»æ­æ™“ç­”æ¡ˆ
3. **åŠ¨æ€å†³ç­–**ï¼šæ ¹æ®å­¦ç”Ÿå›ç­”è´¨é‡å†³å®šæ˜¯ç»™æç¤ºè¿˜æ˜¯è¿›å…¥ä¸‹ä¸€æ­¥

è¿™äº›éœ€æ±‚ç”¨ä¼ ç»Ÿçš„"è¯·æ±‚-å“åº”"æ¨¡å¼å¾ˆéš¾å®ç°ï¼Œä½† Agent æ¶æ„å¤©ç„¶æ”¯æŒã€‚

---

## 2. ç³»ç»Ÿæ¶æ„

### 2.1 æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Frontend (React)                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ Coaching â”‚ â”‚  Skill   â”‚ â”‚  Vocab   â”‚ â”‚ Surgery  â”‚            â”‚
â”‚  â”‚   View   â”‚ â”‚   View   â”‚ â”‚   View   â”‚ â”‚   View   â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜            â”‚
â”‚       â”‚            â”‚            â”‚            â”‚                   â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                           â”‚                                      â”‚
â”‚                    apiService.ts                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚ HTTPS
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Backend (FastAPI)                            â”‚
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                    /api/ai/agent/*                          â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚ â”‚
â”‚  â”‚  â”‚  init   â”‚  â”‚  input  â”‚  â”‚  state  â”‚  â”‚  reset  â”‚        â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚          â”‚            â”‚           â”‚            â”‚                 â”‚
â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                           â”‚                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                   Agent Dispatcher                          â”‚ â”‚
â”‚  â”‚  æ ¹æ® module_type åˆ†å‘åˆ°å¯¹åº”çš„ Agent å­ç±»                    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚          â”‚            â”‚           â”‚            â”‚                 â”‚
â”‚          â–¼            â–¼           â–¼            â–¼                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ Coaching â”‚  â”‚  Skill   â”‚  â”‚  Vocab   â”‚  â”‚ Surgery  â”‚         â”‚
â”‚  â”‚  Agent   â”‚  â”‚  Agent   â”‚  â”‚  Agent   â”‚  â”‚  Agent   â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚          â”‚            â”‚           â”‚            â”‚                 â”‚
â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                           â”‚                                      â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”                               â”‚
â”‚                    â”‚  AI Service â”‚ â†â”€â”€ Gemini / Zhipu API        â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ¨¡å—åŒ–è®¾è®¡

```
backend/services/agents/
â”œâ”€â”€ __init__.py           # âœ… Agent å·¥å‚å‡½æ•°
â”œâ”€â”€ base_agent.py         # âœ… æŠ½è±¡åŸºç±»ï¼Œå®šä¹‰å…¬å…±æ¥å£
â”œâ”€â”€ coaching_agent.py     # âœ… ä»£ç»ƒçº é”™ Agent (å·²å®ç°)
â”œâ”€â”€ skill_agent.py        # ğŸ“‹ æŠ€èƒ½æ•™å­¦ Agent (æœªæ¥)
â”œâ”€â”€ vocab_agent.py        # ğŸ“‹ ç”Ÿè¯æ”»å…‹ Agent (æœªæ¥)
â””â”€â”€ surgery_agent.py      # ğŸ“‹ éš¾å¥çªç ´ Agent (æœªæ¥)

backend/prompts/
â”œâ”€â”€ coaching_tutor.md     # âœ… ä»£ç»ƒ Agent ç³»ç»Ÿ Prompt
â”œâ”€â”€ skill_tutor.md        # ğŸ“‹ æŠ€èƒ½ Agent ç³»ç»Ÿ Prompt (æœªæ¥)
â”œâ”€â”€ vocab_tutor.md        # ğŸ“‹ ç”Ÿè¯ Agent ç³»ç»Ÿ Prompt (æœªæ¥)
â””â”€â”€ surgery_tutor.md      # ğŸ“‹ éš¾å¥ Agent ç³»ç»Ÿ Prompt (æœªæ¥)
```

---

## 3. Agent æ ¸å¿ƒæ¦‚å¿µ

### 3.1 ä¼šè¯çŠ¶æ€ (Session State)

æ¯ä¸ª Agent ä¼šè¯éƒ½æœ‰ç‹¬ç«‹çš„çŠ¶æ€ï¼š

```python
@dataclass
class AgentState:
    session_id: str              # ä¼šè¯å”¯ä¸€æ ‡è¯†
    module_type: str             # "coaching" | "skill" | "vocab" | "surgery"
    current_phase: int           # å½“å‰æ•™å­¦é˜¶æ®µ (1-6)
    wrong_count: int             # ç´¯è®¡é”™è¯¯æ¬¡æ•°
    conversation_history: list   # å¯¹è¯å†å²
    context: dict                # æ¨¡å—ç‰¹å®šä¸Šä¸‹æ–‡ (é¢˜ç›®ä¿¡æ¯ã€å•è¯ä¿¡æ¯ç­‰)
    pending_action: dict | None  # å¾…æ‰§è¡Œçš„åŠ¨ä½œ
    created_at: datetime
    updated_at: datetime
```

### 3.2 å·¥å…· (Tools)

Agent å¯ä»¥è°ƒç”¨çš„ã€ŒæŠ€èƒ½ã€ï¼Œæ¯ä¸ªæ¨¡å—æœ‰ä¸åŒçš„å·¥å…·é›†ï¼š

| æ¨¡å— | å¯ç”¨å·¥å…· | è¯´æ˜ |
|------|----------|------|
| **Coaching** | `send_message`, `publish_task(voice/highlight/select)`, `send_gps_card`, `advance_phase`, `start_review` | é”™é¢˜è®²è§£ |
| **Skill** | `send_message`, `show_skill_node`, `start_quiz`, `show_feedback` | æŠ€èƒ½æ•™å­¦ |
| **Vocab** | `send_message`, `show_word_card`, `play_audio`, `mark_learned`, `next_word` | å•è¯å­¦ä¹  |
| **Surgery** | `send_message`, `show_chunks`, `simplify_sentence`, `show_core_sentence`, `play_audio` | éš¾å¥åˆ†æ |

### 3.3 åŠ¨ä½œ (Action)

Agent å†³ç­–åè¿”å›ç»™å‰ç«¯çš„æŒ‡ä»¤ï¼š

```python
class AgentAction:
    type: str      # "SEND_MESSAGE" | "PUBLISH_TASK" | "ADVANCE_PHASE" | ...
    payload: dict  # åŠ¨ä½œå‚æ•°
    
# ç¤ºä¾‹
{
    "type": "SEND_MESSAGE",
    "payload": {
        "text": "å¾ˆå¥½ï¼ä½ æ‰¾åˆ°äº†å…³é”®è¯ ğŸ‘ é‚£æ¥ä¸‹æ¥...",
        "require_task": true,
        "task_type": "highlight"
    }
}
```

---

## 4. å››å¤§æ•™å­¦æ¨¡å—è¯¦è§£

### 4.1 CoachingAgent (ä»£ç»ƒçº é”™)

**ç›®æ ‡**ï¼šé€šè¿‡è‹æ ¼æ‹‰åº•å¼æé—®ï¼Œå¼•å¯¼å­¦ç”Ÿè‡ªå·±å‘ç°é”™è¯¯å¹¶æ”¹æ­£ã€‚

**æ•™å­¦æµç¨‹**ï¼š

```
Phase 1: å½’å› è¯Šæ–­ â”€â”€â”€â”€â”€â–º è¯¢é—®å­¦ç”Ÿä¸ºä»€ä¹ˆé€‰è¿™ä¸ªç­”æ¡ˆ
    â”‚                    å·¥å…·: publish_task(voice)
    â–¼
Phase 2: æŠ€èƒ½å¬å› â”€â”€â”€â”€â”€â–º å±•ç¤º GPS è§£é¢˜å¡
    â”‚                    å·¥å…·: send_gps_card
    â–¼
Phase 3: è·¯æ ‡å®šä½ â”€â”€â”€â”€â”€â–º å¼•å¯¼æ‰¾é¢˜å¹²å…³é”®è¯
    â”‚                    å·¥å…·: publish_task(highlight)
    â–¼
Phase 4: æœåŸå¥ â”€â”€â”€â”€â”€â”€â–º å¼•å¯¼åœ¨æ–‡ç« ä¸­å®šä½
    â”‚                    å·¥å…·: publish_task(highlight)
    â–¼
Phase 5: çº åé”å®š â”€â”€â”€â”€â”€â–º è®©å­¦ç”Ÿé‡æ–°é€‰æ‹©
    â”‚                    å·¥å…·: publish_task(select)
    â–¼
Phase 6: æŠ€å·§å¤ç›˜ â”€â”€â”€â”€â”€â–º æ€»ç»“è§£é¢˜æ–¹æ³•
                         å·¥å…·: start_review
```

**ç‰¹æ®Šè§„åˆ™**ï¼š
- å­¦ç”Ÿç´¯è®¡ 2 æ¬¡é€‰é”™ â†’ å¼ºåˆ¶è¿›å…¥ Phase 6 (å¤ç›˜)
- å­¦ç”Ÿä¸­é€”é€‰å¯¹ â†’ è·³è¿‡å‰©ä½™æ­¥éª¤ï¼Œç›´æ¥å¤ç›˜

**Prompt æ–‡ä»¶**: `prompts/coaching_tutor.md`

---

### 4.2 SkillAgent (æŠ€èƒ½æ•™å­¦)

**ç›®æ ‡**ï¼šæ•™æˆé˜…è¯»ç†è§£è§£é¢˜æŠ€èƒ½ï¼ˆå¦‚ GPS å®šä½æ³•ï¼‰ã€‚

**æ•™å­¦æµç¨‹**ï¼š

```
Node 0: ç­‰å¾…å¼€å§‹ â”€â”€â”€â”€â”€â–º æ•™å¸ˆæ§åˆ¶å¼€å§‹
    â”‚
    â–¼
Node 1: ä¿¡æ¯è¿‡è½½ â”€â”€â”€â”€â”€â–º å±•ç¤ºå¤æ‚é¢˜ç›®ï¼Œè®©å­¦ç”Ÿæ„Ÿå—å›°éš¾
    â”‚
    â–¼
Node 2: æŠ€èƒ½è®²è§£ â”€â”€â”€â”€â”€â–º å±•ç¤º GPS å¡ç‰‡ï¼Œè®²è§£æ­¥éª¤
    â”‚
    â–¼
Node 3: Mini Quiz â”€â”€â”€â”€â–º ç®€å•ç»ƒä¹ ï¼ŒéªŒè¯ç†è§£
    â”‚
    â–¼
Node 4: å®Œæˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º è§£é”ä¸‹ä¸€å…³
```

**Prompt æ–‡ä»¶**: `prompts/skill_tutor.md` (å¾…åˆ›å»º)

---

### 4.3 VocabAgent (ç”Ÿè¯æ”»å…‹)

**ç›®æ ‡**ï¼šå¸®åŠ©å­¦ç”ŸæŒæ¡æ–‡ç« ä¸­çš„ç”Ÿè¯ã€‚

**æ•™å­¦æµç¨‹**ï¼š

```
Step 1: å±•ç¤ºè¯å¡ â”€â”€â”€â”€â”€â–º æ˜¾ç¤ºå•è¯ã€éŸ³æ ‡ã€é‡Šä¹‰
    â”‚                   å·¥å…·: show_word_card, play_audio
    â–¼
Step 2: è¯­å¢ƒç†è§£ â”€â”€â”€â”€â”€â–º å±•ç¤ºåŸæ–‡ä¾‹å¥
    â”‚                   å·¥å…·: send_message
    â–¼
Step 3: åŠ©è®°æç¤º â”€â”€â”€â”€â”€â–º å±•ç¤º AI ç”Ÿæˆçš„è®°å¿†æŠ€å·§
    â”‚                   å·¥å…·: send_message
    â–¼
Step 4: ä¸‹ä¸€ä¸ªè¯ â”€â”€â”€â”€â”€â–º æ ‡è®°å·²å­¦ï¼Œè¿›å…¥ä¸‹ä¸€ä¸ª
                        å·¥å…·: mark_learned, next_word
```

**Prompt æ–‡ä»¶**: `prompts/vocab_tutor.md` (å¾…åˆ›å»º)

---

### 4.4 SurgeryAgent (éš¾å¥çªç ´)

**ç›®æ ‡**ï¼šå¸®åŠ©å­¦ç”Ÿç†è§£å’Œæ‹†è§£é•¿éš¾å¥ã€‚

**æ•™å­¦æµç¨‹**ï¼š

```
Step 1: å±•ç¤ºåŸå¥ â”€â”€â”€â”€â”€â–º å®Œæ•´å±•ç¤ºé•¿éš¾å¥
    â”‚
    â–¼
Step 2: æˆåˆ†åˆ‡åˆ† â”€â”€â”€â”€â”€â–º æŒ‰è¯­æ³•æˆåˆ†æ‹†åˆ†å¹¶è´´æ ‡ç­¾
    â”‚                   å·¥å…·: show_chunks
    â–¼
Step 3: è¯†åˆ«ä¸»å¹² â”€â”€â”€â”€â”€â–º å¼•å¯¼æ‰¾å‡ºä¸»è°“å®¾
    â”‚                   å·¥å…·: simplify_sentence
    â–¼
Step 4: æ ¸å¿ƒå¥ â”€â”€â”€â”€â”€â”€â–º å±•ç¤ºåˆ é™¤ä¿®é¥°è¯­åçš„ç®€åŒ–å¥
    â”‚                   å·¥å…·: show_core_sentence, play_audio
    â–¼
Step 5: å¤ç›˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º å›é¡¾å®Œæ•´ç»“æ„
```

**æ•°æ®æ¥æº**: é¡¹ç›®1 çš„ `surgery_prompts.yaml` ç”Ÿæˆçš„ `components` æ•°æ®ï¼ŒåŒ…å« `deletable` å­—æ®µæ ‡è®°å¯åˆ é™¤æˆåˆ†ã€‚

**Prompt æ–‡ä»¶**: `prompts/surgery_tutor.md` (å¾…åˆ›å»º)

---

## 5. API æ¥å£è®¾è®¡

### 5.1 åˆå§‹åŒ–ä¼šè¯

```
POST /api/ai/agent/init
```

**è¯·æ±‚ä½“**ï¼š
```json
{
    "module_type": "coaching",  // coaching | skill | vocab | surgery
    "context": {
        // æ¨¡å—ç‰¹å®šçš„ä¸Šä¸‹æ–‡
        // coaching: question_id, student_answer, student_name, student_level
        // vocab: word, definition, context_sentence
        // surgery: sentence, components
    }
}
```

**å“åº”**ï¼š
```json
{
    "session_id": "uuid-xxx-xxx",
    "initial_action": {
        "type": "SEND_MESSAGE",
        "payload": {
            "text": "å“å‘€ Alexï¼Œç¬¬1é¢˜æ‰å‘é‡Œäº† ğŸ™ˆ...",
            "require_task": false
        }
    },
    "state": {
        "current_phase": 1,
        "wrong_count": 0
    }
}
```

---

### 5.2 å¤„ç†å­¦ç”Ÿè¾“å…¥

```
POST /api/ai/agent/input
```

**è¯·æ±‚ä½“**ï¼š
```json
{
    "session_id": "uuid-xxx-xxx",
    "input_type": "voice_response",  // è¾“å…¥ç±»å‹
    "input_data": {
        "transcript": "æˆ‘é€‰Aæ˜¯å› ä¸ºæ–‡ç« è¯´äº† beautiful..."
    }
}
```

**è¾“å…¥ç±»å‹æšä¸¾**ï¼š
| input_type | è¯´æ˜ | input_data ç¤ºä¾‹ |
|------------|------|-----------------|
| `voice_response` | è¯­éŸ³å›ç­” | `{"transcript": "..."}` |
| `highlight` | ç”»çº¿é€‰ä¸­ | `{"text": "selected text", "paragraph_index": 1}` |
| `select_option` | é€‰æ‹©é€‰é¡¹ | `{"option_id": "B"}` |
| `word_click` | ç‚¹å‡»å•è¯ | `{"word": "beautiful"}` |
| `task_completed` | ä»»åŠ¡å®Œæˆ | `{}` |

**å“åº”**ï¼š
```json
{
    "action": {
        "type": "PUBLISH_TASK",
        "payload": {
            "text": "å¾ˆå¥½ï¼ç°åœ¨å»æ–‡ç« é‡Œæ‰¾æ‰¾åŒ…å«è¿™ä¸ªå…³é”®è¯çš„å¥å­ ğŸ‘€",
            "task_type": "highlight"
        }
    },
    "state": {
        "current_phase": 3,
        "wrong_count": 0
    }
}
```

---

### 5.3 è·å–ä¼šè¯çŠ¶æ€

```
GET /api/ai/agent/state/{session_id}
```

**å“åº”**ï¼š
```json
{
    "session_id": "uuid-xxx-xxx",
    "module_type": "coaching",
    "current_phase": 3,
    "wrong_count": 0,
    "created_at": "2025-12-16T16:00:00Z",
    "updated_at": "2025-12-16T16:05:00Z"
}
```

---

### 5.4 é‡ç½®ä¼šè¯

```
POST /api/ai/agent/reset/{session_id}
```

**å“åº”**ï¼š
```json
{
    "success": true,
    "message": "Session reset successfully"
}
```

---

## 6. å‰ç«¯é€‚é…æŒ‡å—

å‰ç«¯ UI **ä¸éœ€è¦æ”¹åŠ¨**ï¼Œåªéœ€è¦ä¿®æ”¹ `apiService.ts` ä¸­çš„ API è°ƒç”¨ï¼š

### 6.1 åŸæœ‰è°ƒç”¨æ–¹å¼

```typescript
// æ—§ï¼šæ¯æ¬¡è¯·æ±‚ç‹¬ç«‹ç”Ÿæˆè¯æœ¯
const response = await apiService.generateCoachingScript({
    question_id,
    student_answer,
    phase,
    ...
});
setAiScript(response.script);
```

### 6.2 æ–°çš„è°ƒç”¨æ–¹å¼

```typescript
// æ–°ï¼šåˆå§‹åŒ–ä¼šè¯
const initResponse = await apiService.initAgent({
    module_type: 'coaching',
    context: { question_id, student_answer, student_name, student_level }
});
setSessionId(initResponse.session_id);
handleAction(initResponse.initial_action);

// æ–°ï¼šå¤„ç†å­¦ç”Ÿè¾“å…¥
const inputResponse = await apiService.agentInput({
    session_id,
    input_type: 'voice_response',
    input_data: { transcript }
});
handleAction(inputResponse.action);
```

### 6.3 å¤„ç† Action

```typescript
function handleAction(action: AgentAction) {
    switch (action.type) {
        case 'SEND_MESSAGE':
            setAiScript(action.payload.text);
            if (action.payload.require_task) {
                setCanPublishTask(true);
                setTaskType(action.payload.task_type);
            }
            break;
        case 'ADVANCE_PHASE':
            advanceCoachingPhase();
            break;
        case 'START_REVIEW':
            setCoachingPhase(6);
            break;
        // ...
    }
}
```

---

## 7. å®ç°ä¼˜å…ˆçº§

| ä¼˜å…ˆçº§ | æ¨¡å— | çŠ¶æ€ | Prompt | å‰ç«¯ |
|--------|------|------|--------|------|
| P0 | CoachingAgent | âœ… **å·²å®Œæˆ** | âœ… å·²æœ‰ | âœ… å·²é›†æˆ |
| P1 | SkillAgent | ğŸ“‹ è§„åˆ’ä¸­ | âŒ å¾…åˆ›å»º | - |
| P2 | VocabAgent | ğŸ“‹ è§„åˆ’ä¸­ | âŒ å¾…åˆ›å»º | - |
| P3 | SurgeryAgent | ğŸ“‹ è§„åˆ’ä¸­ | âŒ å¾…åˆ›å»º | - |

---

## 8. å·²å®Œæˆå·¥ä½œ

âœ… **CoachingAgent å·²å®Œæˆ (2025-12-16)**ï¼š

| ç»„ä»¶ | æ–‡ä»¶ | çŠ¶æ€ |
|------|------|------|
| åŸºç±» | `backend/services/agents/base_agent.py` | âœ… |
| ä»£ç»ƒ Agent | `backend/services/agents/coaching_agent.py` | âœ… |
| å·¥å‚å‡½æ•° | `backend/services/agents/__init__.py` | âœ… |
| API ç«¯ç‚¹ | `backend/routers/ai.py` (+Agent ç«¯ç‚¹) | âœ… |
| å‰ç«¯ API | `frontend/src/services/apiService.ts` | âœ… |
| å‰ç«¯é›†æˆ | `frontend/src/components/stages/Coaching/CoachCoachingView.tsx` | âœ… |

---

## 9. ä¸‹ä¸€æ­¥

1. **ç­‰å¾… Prompt**: åˆ›å»º `skill_tutor.md`, `vocab_tutor.md`, `surgery_tutor.md`
2. **æ‰©å±• Agent**: å®ç° `SkillAgent`, `VocabAgent`, `SurgeryAgent`
